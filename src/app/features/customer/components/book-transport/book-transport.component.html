<div class="book-transport-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2 class="page-title">
          <i class="fas fa-truck me-2"></i>
          Book Transport Service
        </h2>
        <p class="page-subtitle">Get instant quotes and book your transport service</p>
      </div>
      <div class="col-md-4 text-end">
        <div class="help-section">
          <button class="btn btn-outline-info btn-sm" (click)="toggleHelp()">
            <i class="fas fa-question-circle me-1"></i> Help
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Section -->
  <div class="alert alert-info" *ngIf="showHelp">
    <div class="row">
      <div class="col-md-4">
        <h6><i class="fas fa-info-circle me-2"></i>How to Book</h6>
        <p>Follow the 4-step process to complete your booking easily.</p>
      </div>
      <div class="col-md-4">
        <h6><i class="fas fa-phone me-2"></i>Need Assistance?</h6>
        <p>Call us at <strong>+1-800-JR-TRANS</strong> for immediate help.</p>
      </div>
      <div class="col-md-4">
        <h6><i class="fas fa-clock me-2"></i>Booking Hours</h6>
        <p>24/7 online booking available. Phone support: 9 AM - 6 PM EST.</p>
      </div>
    </div>
  </div>

  <!-- Booking Confirmation -->
  <div class="alert alert-success confirmation-alert" *ngIf="bookingConfirmed">
    <div class="text-center">
      <i class="fas fa-check-circle fa-3x mb-3"></i>
      <h4>Booking Confirmed!</h4>
      <p class="mb-2">Your booking has been successfully confirmed.</p>
      <p class="confirmation-number">Confirmation Number: <strong>{{ confirmationNumber }}</strong></p>
      <div class="mt-3">
        <button class="btn btn-primary me-2" (click)="navigateToBookings()">
          <i class="fas fa-list me-1"></i> View Bookings
        </button>
        <button class="btn btn-outline-primary" (click)="resetForm()">
          <i class="fas fa-plus me-1"></i> New Booking
        </button>
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="progress-section" *ngIf="!bookingConfirmed">
    <div class="progress-container">
      <div class="progress-step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <div class="step-circle">
          <i class="fas fa-map-marker-alt" *ngIf="currentStep <= 1"></i>
          <i class="fas fa-check" *ngIf="currentStep > 1"></i>
        </div>
        <div class="step-label">Route Details</div>
      </div>
      <div class="progress-line" [class.active]="currentStep > 1"></div>
      <div class="progress-step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <div class="step-circle">
          <i class="fas fa-boxes" *ngIf="currentStep <= 2"></i>
          <i class="fas fa-check" *ngIf="currentStep > 2"></i>
        </div>
        <div class="step-label">Goods Details</div>
      </div>
      <div class="progress-line" [class.active]="currentStep > 2"></div>
      <div class="progress-step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
        <div class="step-circle">
          <i class="fas fa-truck" *ngIf="currentStep <= 3"></i>
          <i class="fas fa-check" *ngIf="currentStep > 3"></i>
        </div>
        <div class="step-label">Vehicle Selection</div>
      </div>
      <div class="progress-line" [class.active]="currentStep > 3"></div>
      <div class="progress-step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4">
        <div class="step-circle">
          <i class="fas fa-credit-card" *ngIf="currentStep <= 4"></i>
          <i class="fas fa-check" *ngIf="currentStep > 4"></i>
        </div>
        <div class="step-label">Contact & Payment</div>
      </div>
    </div>
  </div>

  <!-- Booking Form -->
  <form [formGroup]="bookingForm" (ngSubmit)="submitBooking()" novalidate *ngIf="!bookingConfirmed">
    
    <!-- Step 1: Route Details -->
    <div class="step-content" *ngIf="currentStep === 1">
      <div class="step-card">
        <div class="card-header">
          <h4><i class="fas fa-map-marker-alt me-2"></i>Step 1: Route Details</h4>
          <p class="text-muted mb-0">Enter pickup and dropoff locations</p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label required">
                <i class="fas fa-map-pin me-1"></i>Pickup Location
              </label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="pickupLocation"
                [class.is-invalid]="isFieldInvalid('pickupLocation')"
                placeholder="Enter pickup address">
              <div class="invalid-feedback" *ngIf="isFieldInvalid('pickupLocation')">
                {{ getFieldError('pickupLocation') }}
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label required">
                <i class="fas fa-map-pin me-1"></i>Dropoff Location
              </label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="dropoffLocation"
                [class.is-invalid]="isFieldInvalid('dropoffLocation')"
                placeholder="Enter dropoff address">
              <div class="invalid-feedback" *ngIf="isFieldInvalid('dropoffLocation')">
                {{ getFieldError('dropoffLocation') }}
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label required">
                <i class="fas fa-calendar me-1"></i>Pickup Date
              </label>
              <input 
                type="date" 
                class="form-control" 
                formControlName="pickupDate"
                [class.is-invalid]="isFieldInvalid('pickupDate')"
                [min]="minDate">
              <div class="invalid-feedback" *ngIf="isFieldInvalid('pickupDate')">
                {{ getFieldError('pickupDate') }}
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label required">
                <i class="fas fa-clock me-1"></i>Pickup Time
              </label>
              <select 
                class="form-control" 
                formControlName="pickupTime"
                [class.is-invalid]="isFieldInvalid('pickupTime')">
                <option value="">Select time</option>
                <option *ngFor="let slot of availableTimeSlots" [value]="slot.value">
                  {{ slot.label }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="isFieldInvalid('pickupTime')">
                {{ getFieldError('pickupTime') }}
              </div>
            </div>
          </div>

          <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Tip:</strong> Provide detailed addresses for accurate quote calculation.
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Goods Details -->
    <div class="step-content" *ngIf="currentStep === 2">
      <div class="step-card">
        <div class="card-header">
          <h4><i class="fas fa-boxes me-2"></i>Step 2: Goods Details</h4>
          <p class="text-muted mb-0">Describe what you're shipping</p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label required">
                <i class="fas fa-tag me-1"></i>Goods Type
              </label>
              <select 
                class="form-control" 
                formControlName="goodsType"
                [class.is-invalid]="isFieldInvalid('goodsType')">
                <option value="">Select goods type</option>
                <option *ngFor="let type of goodsTypes" [value]="type">{{ type }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="isFieldInvalid('goodsType')">
                {{ getFieldError('goodsType') }}
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label required">
                <i class="fas fa-weight me-1"></i>Weight (in kg)
              </label>
              <input 
                type="number" 
                class="form-control" 
                formControlName="goodsWeight"
                [class.is-invalid]="isFieldInvalid('goodsWeight')"
                placeholder="Enter weight in kg"
                min="1">
              <div class="invalid-feedback" *ngIf="isFieldInvalid('goodsWeight')">
                {{ getFieldError('goodsWeight') }}
              </div>
            </div>

            <div class="col-12 mb-3">
              <label class="form-label required">
                <i class="fas fa-file-alt me-1"></i>Goods Description
              </label>
              <textarea 
                class="form-control" 
                formControlName="goodsDescription"
                [class.is-invalid]="isFieldInvalid('goodsDescription')"
                rows="4"
                placeholder="Provide detailed description of goods (min. 10 characters)"></textarea>
              <div class="invalid-feedback" *ngIf="isFieldInvalid('goodsDescription')">
                {{ getFieldError('goodsDescription') }}
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Special Handling Requirements</label>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  formControlName="fragile"
                  id="fragile">
                <label class="form-check-label" for="fragile">
                  <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                  Fragile Items
                </label>
              </div>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  formControlName="perishable"
                  id="perishable">
                <label class="form-check-label" for="perishable">
                  <i class="fas fa-snowflake text-info me-1"></i>
                  Perishable Goods
                </label>
              </div>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  formControlName="specialHandling"
                  id="specialHandling">
                <label class="form-check-label" for="specialHandling">
                  <i class="fas fa-hand-paper text-danger me-1"></i>
                  Special Handling Required
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Vehicle Selection -->
    <div class="step-content" *ngIf="currentStep === 3">
      <div class="step-card">
        <div class="card-header">
          <h4><i class="fas fa-truck me-2"></i>Step 3: Select Vehicle</h4>
          <p class="text-muted mb-0">Choose the best vehicle for your needs</p>
        </div>
        <div class="card-body">
          <!-- Loading State -->
          <div class="text-center py-5" *ngIf="isLoadingVehicles">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading vehicles...</span>
            </div>
            <p class="mt-3 text-muted">Finding available vehicles...</p>
          </div>

          <!-- Vehicle Options -->
          <div class="row" *ngIf="!isLoadingVehicles">
            <div class="col-md-4 mb-3" *ngFor="let vehicle of availableVehicles">
              <div class="vehicle-card" 
                   [class.selected]="selectedVehicleId === vehicle.id"
                   (click)="selectVehicle(vehicle)">
                <div class="vehicle-header">
                  <div class="vehicle-icon">
                    <i [class]="vehicle.icon + ' fa-2x'"></i>
                  </div>
                  <div class="availability-badge" [class]="getAvailabilityClass(vehicle.availability)">
                    <i [class]="'fas ' + getAvailabilityIcon(vehicle.availability) + ' me-1'"></i>
                    {{ vehicle.availability || 'Unknown' }}
                  </div>
                </div>
                
                <h5 class="vehicle-name">{{ vehicle.name }}</h5>
                <p class="vehicle-description">{{ vehicle.description }}</p>
                
                <div class="vehicle-specs">
                  <div class="spec-item">
                    <i class="fas fa-weight-hanging me-1"></i>
                    Capacity: {{ vehicle.capacity }} tons
                  </div>
                  <div class="spec-item">
                    <i class="fas fa-ruler-combined me-1"></i>
                    {{ vehicle.dimensions }}
                  </div>
                </div>

                <div class="vehicle-features">
                  <div class="feature-badge" *ngFor="let feature of vehicle.features">
                    <i class="fas fa-check-circle me-1"></i>{{ feature }}
                  </div>
                </div>

                <div class="vehicle-price">
                  <div class="price-label">Estimated Price</div>
                  <div class="price-amount">₹{{ calculateVehiclePrice(vehicle) | number }}</div>
                  <div class="price-breakdown">
                    Base: ₹{{ vehicle.basePrice }} + ₹{{ vehicle.pricePerKm }}/km
                  </div>
                </div>

                <div class="select-indicator" *ngIf="selectedVehicleId === vehicle.id">
                  <i class="fas fa-check-circle"></i> Selected
                </div>
              </div>
            </div>
          </div>

          <!-- No Vehicles Available -->
          <div class="alert alert-warning" *ngIf="!isLoadingVehicles && availableVehicles.length === 0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No vehicles available for the specified weight. Please adjust goods weight.
          </div>

          <!-- Validation Error -->
          <div class="alert alert-danger mt-3" *ngIf="isFieldInvalid('selectedVehicleType')">
            {{ getFieldError('selectedVehicleType') }}
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Contact & Payment -->
    <div class="step-content" *ngIf="currentStep === 4">
      <div class="step-card">
        <div class="card-header">
          <h4><i class="fas fa-credit-card me-2"></i>Step 4: Contact & Payment</h4>
          <p class="text-muted mb-0">Complete your booking</p>
        </div>
        <div class="card-body">
          <!-- Contact Information -->
          <div class="section-header mb-3">
            <h5><i class="fas fa-user me-2"></i>Contact Information</h5>
          </div>
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label required">
                <i class="fas fa-user me-1"></i>Full Name
              </label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="contactName"
                [class.is-invalid]="isFieldInvalid('contactName')"
                placeholder="Enter your full name">
              <div class="invalid-feedback" *ngIf="isFieldInvalid('contactName')">
                {{ getFieldError('contactName') }}
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label required">
                <i class="fas fa-phone me-1"></i>Phone Number
              </label>
              <input 
                type="tel" 
                class="form-control" 
                formControlName="contactPhone"
                [class.is-invalid]="isFieldInvalid('contactPhone')"
                placeholder="10-digit phone number">
              <div class="invalid-feedback" *ngIf="isFieldInvalid('contactPhone')">
                {{ getFieldError('contactPhone') }}
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label required">
                <i class="fas fa-envelope me-1"></i>Email Address
              </label>
              <input 
                type="email" 
                class="form-control" 
                formControlName="contactEmail"
                [class.is-invalid]="isFieldInvalid('contactEmail')"
                placeholder="your.email@example.com">
              <div class="invalid-feedback" *ngIf="isFieldInvalid('contactEmail')">
                {{ getFieldError('contactEmail') }}
              </div>
            </div>

            <div class="col-12 mb-3">
              <label class="form-label">
                <i class="fas fa-sticky-note me-1"></i>Additional Notes
              </label>
              <textarea 
                class="form-control" 
                formControlName="additionalNotes"
                rows="3"
                placeholder="Any special instructions or requirements (optional)"></textarea>
            </div>
          </div>

          <hr class="my-4">

          <!-- Payment Method -->
          <div class="section-header mb-3">
            <h5><i class="fas fa-credit-card me-2"></i>Payment Method</h5>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3" *ngFor="let method of paymentMethods">
              <div class="payment-option" 
                   [class.selected]="bookingForm.get('paymentMethod')?.value === method.value"
                   (click)="bookingForm.patchValue({paymentMethod: method.value})">
                <div class="payment-icon">
                  <i [class]="'fas ' + method.icon"></i>
                </div>
                <div class="payment-label">{{ method.label }}</div>
                <div class="payment-check" *ngIf="bookingForm.get('paymentMethod')?.value === method.value">
                  <i class="fas fa-check-circle"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="alert alert-danger mt-3" *ngIf="isFieldInvalid('paymentMethod')">
            {{ getFieldError('paymentMethod') }}
          </div>

          <hr class="my-4">

          <!-- Booking Summary -->
          <div class="section-header mb-3">
            <h5><i class="fas fa-file-invoice me-2"></i>Booking Summary</h5>
          </div>

          <div class="booking-summary">
            <div class="summary-row">
              <span>Vehicle Price:</span>
              <span>₹{{ selectedVehicle ? calculateVehiclePrice(selectedVehicle) : 0 | number }}</span>
            </div>
            <div class="summary-row">
              <span>Insurance (5%):</span>
              <span>₹{{ calculateInsuranceCost() | number }}</span>
            </div>
            <div class="summary-row">
              <span>Tax (18%):</span>
              <span>₹{{ calculateTax() | number }}</span>
            </div>
            <div class="summary-row total">
              <span><strong>Total Amount:</strong></span>
              <span><strong>₹{{ calculateTotalAmount() | number }}</strong></span>
            </div>
          </div>

          <hr class="my-4">

          <!-- Terms and Conditions -->
          <div class="form-check mb-3">
            <input 
              class="form-check-input" 
              type="checkbox" 
              formControlName="agreeToTerms"
              [class.is-invalid]="isFieldInvalid('agreeToTerms')"
              id="agreeToTerms">
            <label class="form-check-label" for="agreeToTerms">
              I agree to the <a href="/terms" target="_blank">Terms and Conditions</a> and 
              <a href="/privacy" target="_blank">Privacy Policy</a>
            </label>
            <div class="invalid-feedback d-block" *ngIf="isFieldInvalid('agreeToTerms')">
              {{ getFieldError('agreeToTerms') }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <div class="row">
        <div class="col-6">
          <button 
            type="button" 
            class="btn btn-outline-secondary"
            (click)="prevStep()"
            [disabled]="currentStep === 1">
            <i class="fas fa-arrow-left me-1"></i> Previous
          </button>
        </div>
        <div class="col-6 text-end">
          <button 
            type="button" 
            class="btn btn-primary"
            *ngIf="currentStep < totalSteps"
            (click)="nextStep()"
            [disabled]="!isStepValid(currentStep)">
            Next <i class="fas fa-arrow-right ms-1"></i>
          </button>
          
          <button 
            type="submit" 
            class="btn btn-success"
            *ngIf="currentStep === totalSteps"
            [disabled]="!bookingForm.valid || !selectedVehicle || isSubmitting">
            <span *ngIf="!isSubmitting">
              <i class="fas fa-check me-1"></i> Confirm Booking
            </span>
            <span *ngIf="isSubmitting">
              <span class="spinner-border spinner-border-sm me-1" role="status"></span>
              Processing...
            </span>
          </button>
        </div>
      </div>
    </div>
  </form>
</div>