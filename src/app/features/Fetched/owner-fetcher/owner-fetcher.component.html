<div class="p-3">
  <h2 class="fw-bold text-primary mb-3">Owner Management</h2>
  <input type="text" class="form-control mb-3" placeholder="Search owners..." (input)="onQuickFilterChanged($event)" />

  <ag-grid-angular class="ag-theme-alpine" style="width: 100%; height: 600px;" [rowData]="ownersForGrid"
    [columnDefs]="columnDefs" [defaultColDef]="defaultColDef" [masterDetail]="true"
    [detailCellRendererParams]="detailCellRendererParams" (gridReady)="onGridReady($event)">
  </ag-grid-angular>

  <div class="owners-tree">
    <div *ngFor="let item of ownersWithDrivers" class="owner-card mb-3">
      <div class="owner-header p-3 border rounded" (click)="toggleOwnerExpansion(item.owner.id)"
        [class.bg-light]="item.expanded">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            {{item.owner.firstName}} {{item.owner.lastName}}
          </h5>
          <span>
            {{item.expanded ? '▼' : '►'}}
          </span>
        </div>
      </div>

      <div *ngIf="item.expanded" class="drivers-list ps-4 mt-2">
        <div *ngIf="item.loading" class="text-center py-3">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading drivers...</span>
        </div>

        <div *ngIf="!item.loading">
          <div *ngIf="item.drivers.length; else noDrivers">
            <div *ngFor="let driver of item.drivers" class="driver-card p-3 mb-2 border rounded">
              <div *ngIf="!driver.isEditing; else editForm">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-bold">{{driver.firstName}} {{driver.lastName}}</div>
                    <div class="text-muted small">
                      <div>Email: {{driver.email || '-'}}</div>
                      <div>Phone: {{driver.phoneNumber || '-'}}</div>
                      <div>Status: {{driver.status || '-'}}</div>
                    </div>
                  </div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" (click)="startEditDriver(driver, $event)">
                      Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-1" (click)="deleteDriver(driver, $event)">
                      Delete
                    </button>
                  </div>
                </div>
              </div>

              <ng-template #editForm>
  <form (ngSubmit)="saveDriver(driver, $event)" class="edit-driver-form" *ngIf="driver.editData">
    <div class="row g-2 mb-2">
      <div class="col-md-6">
        <label class="form-label small">First Name</label>
        <input type="text" class="form-control form-control-sm" 
               [(ngModel)]="driver.editData!.firstName" name="firstName" required>
      </div>
      <div class="col-md-6">
        <label class="form-label small">Last Name</label>
        <input type="text" class="form-control form-control-sm" 
               [(ngModel)]="driver.editData!.lastName" name="lastName" required>
      </div>
    </div>
    
    <div class="row g-2 mb-2">
      <div class="col-md-6">
        <label class="form-label small">Email</label>
        <input type="email" class="form-control form-control-sm" 
               [(ngModel)]="driver.editData!.email" name="email">
      </div>
      <div class="col-md-6">
        <label class="form-label small">Phone</label>
        <input type="tel" class="form-control form-control-sm" 
               [(ngModel)]="driver.editData!.phoneNumber" name="phoneNumber">
      </div>
    </div>
    
    <div class="row g-2 mb-3">
      <div class="col-md-6">
        <label class="form-label small">Status</label>
        <select class="form-select form-select-sm" [(ngModel)]="driver.editData!.status" name="status">
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
    </div>
    
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-sm btn-outline-secondary me-2" 
              (click)="cancelEdit(driver, $event)">
        Cancel
      </button>
      <button type="submit" class="btn btn-sm btn-primary">
        Save Changes
      </button>
    </div>
  </form>
</ng-template>
            </div>
          </div>

          <!-- ⬅️⬅️ Moved outside the driver *ngFor and directly under item.drivers.length check -->
          <ng-template #noDrivers>
            <div class="alert alert-info mb-0">No drivers found for this owner</div>
          </ng-template>
        </div>

      </div>
    </div>